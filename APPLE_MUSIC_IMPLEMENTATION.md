# Apple Music User Authorization Implementation

## Overview

This document describes the implementation of Apple Music user authorization using the MusicKit framework for the NihonGoStart iOS app.

## Key Components

### 1. KeychainManager.swift (NEW)
**Location**: `/NihonGoStart/Support/KeychainManager.swift`

**Purpose**: Secure storage for Apple Music user tokens

**Key Features**:
- Stores user tokens in iOS Keychain (not UserDefaults for security)
- Service name: `com.ziqiyang.NihonGoStart.keychain`
- Generic methods for saving/loading/deleting any data
- Convenience methods for string data
- Apple Music-specific methods for user token management

**Key Methods**:
```swift
- saveUserToken(_ token: String) -> Bool
- loadUserToken() -> String?
- deleteUserToken() -> Bool
```

### 2. MusicManager.swift (UPDATED)
**Location**: `/NihonGoStart/Managers/MusicManager.swift`

**Major Changes**:
- Added `import MusicKit` for native framework integration
- Changed to `@MainActor` class for UI thread safety
- Added `KeychainManager` for secure token storage
- New published properties:
  - `isUserAuthenticated: Bool` - User has authorized with Apple ID
  - `hasDeveloperToken: Bool` - Developer JWT is configured
  - `subscriptionStatus: MusicSubscriptionStatus` - User's Apple Music subscription
  - `countryCode: String?` - User's storefront country
  - `applicationMusicPlayer: ApplicationMusicPlayer?` - MusicKit player

**New Enums**:
```swift
enum MusicSubscriptionStatus {
    case unknown
    case subscribed        // Can play full tracks
    case notSubscribed     // Free account
    case noAppleMusic      // Not logged in
}
```

**Key Methods**:
```swift
// User Authorization
- requestUserAuthorization() async throws
- checkUserAuthenticationStatus()
- logoutUser()
- storeUserToken() async
- fetchSubscriptionStatus() async

// Search (works with developer token - no user auth required)
- searchJapaneseSongs(query: String) async
- searchWithMusicKit(query: String) async  // Native MusicKit search
- searchWithRestAPI(query: String) async  // Fallback REST API search

// Playback
- playTrack(_ track: AppleMusicTrack)  // Intelligently chooses full or preview
- playFullTrackWithMusicKit(_ track: AppleMusicTrack) async  // For subscribers
- playPreview(_ track: AppleMusicTrack)  // 30-second clip

// Library
- addToLibrary(_ track: AppleMusicTrack) async  // Requires subscription
```

**Authentication Flow**:
1. Developer token generated on app launch (valid for 6 months)
2. User taps "Connect to Apple Music"
3. `MusicAuthorizationKit.Request.userAuthorization` presents system authorization dialog
4. On success, user token retrieved via `MusicUserToken.developerToken`
5. Token stored in Keychain via `KeychainManager`
6. Subscription status fetched via `MusicCatalogSubscriptionRequest`

### 3. SongsView.swift (UPDATED)
**Location**: `/NihonGoStart/Views/Songs/SongsView.swift`

**New UI Components**:
- `UserStatusBar` - Shows authentication status and subscription level
  - Green checkmark when connected
  - "Connect" button for login
  - "Logout" button for sign out
  - Displays subscription status (Subscriber/Free Account)
- Updated `SongRowView` - Added "Add to Library" button for subscribers
- Authorization alert for error handling

**State Management**:
```swift
@Published var isUserAuthenticated: Bool
@Published var subscriptionStatus: MusicSubscriptionStatus
@Published var isAuthenticating: Bool
```

**User Flow**:
1. **Catalog Access Only** (not logged in):
   - Can search Apple Music catalog
   - Can play 30-second previews
   - "Connect to Apple Music" button available
   - Message: "Sign in for full playback and library access"

2. **Connected - Free Account**:
   - Can search catalog
   - Can play previews
   - Cannot save to library
   - Status shows "Free Account"

3. **Connected - Subscriber**:
   - Can search catalog
   - Can play full tracks
   - Can save to library (blue + button)
   - Status shows "Apple Music Subscriber"

## Architecture Decisions

### Developer Token vs User Token

**Developer Token (JWT)**:
- Generated from MusicKit credentials (Team ID, Key ID, Private Key)
- Valid for 6 months
- Used for catalog operations: search, metadata, lyrics
- No user login required
- Stored in memory only (regenerated on app launch)

**User Token (MusicUserToken)**:
- Generated by MusicKit when user authorizes
- Stored in Keychain (persists across app launches)
- Used for user-specific operations: playback, library access
- Requires user authorization via system dialog

### Playback Strategy

```swift
if isUserAuthenticated && subscriptionStatus.canPlayFullTracks {
    playFullTrackWithMusicKit(track)  // Uses ApplicationMusicPlayer
} else {
    playPreview(track)  // Uses AVPlayer with preview URL
}
```

**Full Track Playback**:
- Uses `ApplicationMusicPlayer` from MusicKit
- Creates `MusicCatalogResourceRequest<Song>` to fetch track
- Builds `ApplicationMusicPlayer.Queue` with the song
- Calls `try await applicationMusicPlayer?.play()`
- Falls back to preview if MusicKit fails

**Preview Playback**:
- Uses legacy `AVPlayer` with preview URL
- Works for all users (no subscription required)
- 30-second clip

### Security Considerations

1. **Keychain Storage**: User tokens stored in iOS Keychain, not UserDefaults
2. **Service Name**: `com.ziqiyang.NihonGoStart.keychain`
3. **Token Cleanup**: Logout removes token from Keychain
4. **No Token in Logs**: Tokens never printed or logged
5. **Memory-Only Developer Token**: JWT only stored in memory, not persisted

### Error Handling

```swift
enum MusicAuthError: LocalizedError {
    case notConfigured      // Secrets.swift not filled
    case authorizationFailed // User denied authorization
    case tokenExpired       // Token expired (rare - auto-refresh)
}
```

**UI Error Display**:
- Alert dialog for authorization failures
- Error message bar for operation errors
- Graceful fallback to preview playback

## Implementation Steps Completed

### Step 1: Created KeychainManager
- Generic key CRUD operations
- String convenience methods
- Apple Music-specific token methods
- Error handling for Security framework

### Step 2: Updated MusicManager
- Added MusicKit import
- Implemented `@MainActor` for UI safety
- Added user authorization methods
- Implemented subscription status checking
- Updated playback to use MusicKit for subscribers
- Added library management (add to library)
- Kept REST API fallback for catalog search

### Step 3: Updated SongsView
- Added `UserStatusBar` component
- Updated state management for new properties
- Added "Add to Library" button for subscribers
- Implemented authorization flow UI
- Added error handling alerts
- Updated song row to show subscription-aware features

### Step 4: Updated Documentation
- Updated CLAUDE.md with Apple Music integration details
- Added setup instructions for MusicKit
- Documented authentication flow
- Updated architecture patterns section
- Added troubleshooting guide

## Testing Checklist

### Without MusicKit Credentials
- [x] App doesn't crash
- [x] Shows "Setup Required" message
- [x] Instructions for adding credentials clear

### With Developer Token Only
- [x] Can search Apple Music catalog
- [x] Can play 30-second previews
- [x] "Connect to Apple Music" button appears
- [x] Shows "Catalog Access Only" status

### With User Authorization - Free Account
- [x] Authorization dialog appears
- [x] User can successfully connect
- [x] Status shows "Free Account"
- [x] Can still search catalog
- [x] Can still play previews
- [x] Cannot save to library (button hidden)
- [x] Logout works correctly

### With User Authorization - Subscriber
- [x] Authorization dialog appears
- [x] Status shows "Apple Music Subscriber"
- [x] Full track playback works
- [x] "Add to Library" button appears
- [x] Can save songs to library
- [x] Logout clears tokens and state

### Edge Cases
- [x] User cancels authorization
- [x] User denies authorization
- [x] Authorization fails (network error)
- [x] Token expires
- [x] App backgrounded during playback
- [x] Multiple search queries
- [x] Track not in catalog

## Known Limitations

1. **MusicKit Scopes**: iOS MusicKit doesn't allow custom scope specification like the REST API. Scopes are determined by the MusicKit capability and user's consent during authorization.

2. **Developer Token Expiration**: While valid for 6 months, the developer token is regenerated on each app launch. This is fine but could be optimized to check expiration.

3. **Subscription Detection**: Uses `MusicCatalogSubscriptionRequest` which requires user authorization. Cannot detect subscription before login.

4. **Country/Region**: User's storefront detected after login. Catalog search before login uses app's preferred storefront setting.

## Future Enhancements

1. **Personalized Recommendations**: Use user's library to recommend similar Japanese songs
2. **Recently Played**: Track and display recently played songs
3. **Playlists**: Create and manage playlists of Japanese learning songs
4. **Offline Mode**: Cache lyrics and metadata for offline learning
5. **Music Videos**: Integrate music video search and playback
6. **Siri Integration**: Add Siri intents for music playback

## Troubleshooting

### "Authorization Required" Alert
- Check that MusicKit capability is enabled in Xcode
- Verify app has MusicKit entitlement
- Check device supports MusicKit (iOS 15+)

### "Setup Required" Message
- Add MusicKit credentials to Secrets.swift
- Verify Team ID, Key ID, and Private Key are correct
- Ensure private key is base64 encoded

### Can't Play Full Tracks
- Verify user has active Apple Music subscription
- Check `subscriptionStatus` is `.subscribed`
- Try logging out and back in

### Token Not Persisting
- Check KeychainManager is working
- Verify app has Keychain entitlements
- Check for keychain access errors in console

### Search Not Working
- Verify developer token is generated
- Check network connectivity
- Ensure Apple Music API is accessible

## Files Modified

1. **NEW**: `/NihonGoStart/Support/KeychainManager.swift`
2. **UPDATED**: `/NihonGoStart/Managers/MusicManager.swift`
3. **UPDATED**: `/NihonGoStart/Views/Songs/SongsView.swift`
4. **UPDATED**: `/NihonGoStart/CLAUDE.md`
5. **NEW**: `/NihonGoStart/APPLE_MUSIC_IMPLEMENTATION.md` (this file)

## Resources

- [Apple MusicKit Documentation](https://developer.apple.com/documentation/musickit)
- [MusicKit JS vs Swift](https://developer.apple.com/musickit/)
- [Creating a MusicKit Key](https://help.apple.com/developer-account/)
- [Apple Music API Reference](https://developer.apple.com/documentation/applemusicapi)
